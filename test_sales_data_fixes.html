<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .test-fail { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .test-info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Sales</h1>
        <p class="text-muted">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á API ‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API customers/list.php</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testCustomerListAPI()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
                        <div id="customerListResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>‚è∞ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö API dashboard/summary.php</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="testDashboardAPI()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö API</button>
                        <div id="dashboardResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üéØ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÅ‡∏î‡∏ä‡∏ö‡∏£‡πå‡∏î</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-success" onclick="testDashboardDisplay()">‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</button>
                        <div id="displayResult" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö</h5>
                    </div>
                    <div class="card-body">
                        <div id="summaryResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testResults = {
            customerAPI: false,
            dashboardAPI: false,
            displayTest: false
        };

        async function testCustomerListAPI() {
            const resultDiv = document.getElementById('customerListResult');
            resultDiv.innerHTML = '<div class="spinner-border" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
            
            try {
                const response = await fetch('api/customers/list.php?limit=5');
                const data = await response.json();
                
                if (data.status === 'success' && data.data) {
                    let hasAssignDate = false;
                    let hasReceivedDate = false;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• AssignDate ‡πÅ‡∏•‡∏∞ ReceivedDate ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    data.data.forEach(customer => {
                        if (customer.AssignDate) hasAssignDate = true;
                        if (customer.ReceivedDate) hasReceivedDate = true;
                    });
                    
                    let result = '<div class="test-result test-pass">‚úÖ API ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</div>';
                    result += `<div class="test-result test-info">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${data.data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                    result += `<div class="test-result ${hasAssignDate ? 'test-pass' : 'test-fail'}">
                               ${hasAssignDate ? '‚úÖ' : '‚ùå'} AssignDate: ${hasAssignDate ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•'}
                               </div>`;
                    result += `<div class="test-result ${hasReceivedDate ? 'test-pass' : 'test-info'}">
                               ${hasReceivedDate ? '‚úÖ' : '‚ÑπÔ∏è'} ReceivedDate: ${hasReceivedDate ? '‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏õ‡∏Å‡∏ï‡∏¥)'}
                               </div>`;
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    if (data.data.length > 0) {
                        const sample = data.data[0];
                        result += '<div class="test-result test-info">';
                        result += '<strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong><br>';
                        result += `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${sample.CustomerName}<br>`;
                        result += `AssignDate: ${sample.AssignDate || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}<br>`;
                        result += `CreatedDate: ${sample.CreatedDate || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`;
                        result += '</div>';
                    }
                    
                    resultDiv.innerHTML = result;
                    testResults.customerAPI = true;
                } else {
                    throw new Error(`API Error: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result test-fail">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
                testResults.customerAPI = false;
            }
            updateSummary();
        }

        async function testDashboardAPI() {
            const resultDiv = document.getElementById('dashboardResult');
            resultDiv.innerHTML = '<div class="spinner-border" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
            
            try {
                const response = await fetch('api/dashboard/summary.php?include_customers=true&limit=5');
                const data = await response.json();
                
                if (data.status === 'success' && data.data && data.data.customers) {
                    let hasTimeRemaining = false;
                    let timeRemainingStats = { positive: 0, negative: 0, zero: 0 };
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• time_remaining_days
                    data.data.customers.forEach(customer => {
                        if (customer.time_remaining_days !== null && customer.time_remaining_days !== undefined) {
                            hasTimeRemaining = true;
                            if (customer.time_remaining_days > 0) timeRemainingStats.positive++;
                            else if (customer.time_remaining_days < 0) timeRemainingStats.negative++;
                            else timeRemainingStats.zero++;
                        }
                    });
                    
                    let result = '<div class="test-result test-pass">‚úÖ API ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥</div>';
                    result += `<div class="test-result test-info">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${data.data.customers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>`;
                    result += `<div class="test-result ${hasTimeRemaining ? 'test-pass' : 'test-fail'}">
                               ${hasTimeRemaining ? '‚úÖ' : '‚ùå'} time_remaining_days: ${hasTimeRemaining ? '‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÑ‡∏î‡πâ' : '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì'}
                               </div>`;
                    
                    if (hasTimeRemaining) {
                        result += '<div class="test-result test-info">';
                        result += '<strong>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</strong><br>';
                        result += `‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤: ${timeRemainingStats.positive} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>`;
                        result += `‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤: ${timeRemainingStats.negative} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<br>`;
                        result += `‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢: ${timeRemainingStats.zero} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
                        result += '</div>';
                    }
                    
                    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    if (data.data.customers.length > 0) {
                        const sample = data.data.customers[0];
                        result += '<div class="test-result test-info">';
                        result += '<strong>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</strong><br>';
                        result += `‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: ${sample.CustomerName}<br>`;
                        result += `‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${sample.time_remaining_days} ‡∏ß‡∏±‡∏ô<br>`;
                        result += `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${sample.time_status || '‡πÑ‡∏°‡πà‡∏°‡∏µ'}`;
                        result += '</div>';
                    }
                    
                    resultDiv.innerHTML = result;
                    testResults.dashboardAPI = true;
                } else {
                    throw new Error(`API Error: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result test-fail">‚ùå ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}</div>`;
                testResults.dashboardAPI = false;
            }
            updateSummary();
        }

        function testDashboardDisplay() {
            const resultDiv = document.getElementById('displayResult');
            resultDiv.innerHTML = '<div class="spinner-border" role="status"></div> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏î‡∏™‡∏≠‡∏ö
            const testCustomers = [
                {
                    CustomerName: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö 1',
                    time_remaining_days: 15,
                    assign_date: '2025-01-15',
                    created_date: '2025-01-10'
                },
                {
                    CustomerName: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö 2',
                    time_remaining_days: -5,
                    assign_date: null,
                    created_date: '2025-01-01'
                },
                {
                    CustomerName: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏î‡∏™‡∏≠‡∏ö 3',
                    time_remaining_days: 3,
                    assign_date: '2025-01-20',
                    created_date: '2025-01-15'
                }
            ];
            
            let result = '<div class="test-result test-pass">‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>';
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderTimeProgress
            testCustomers.forEach((customer, index) => {
                const timeDisplay = formatTimeRemaining(customer.time_remaining_days);
                const dateDisplay = formatReceivedDate(customer);
                
                result += `<div class="test-result test-info">
                           <strong>‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ${index + 1}:</strong><br>
                           ‡∏ä‡∏∑‡πà‡∏≠: ${customer.CustomerName}<br>
                           ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${timeDisplay}<br>
                           ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: ${dateDisplay}
                           </div>`;
            });
            
            resultDiv.innerHTML = result;
            testResults.displayTest = true;
            updateSummary();
        }

        function formatTimeRemaining(timeRemaining) {
            if (timeRemaining === null || timeRemaining === undefined) {
                return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
            
            if (timeRemaining < 0) {
                const overdueDays = Math.abs(timeRemaining);
                if (overdueDays > 365) {
                    return '‡πÄ‡∏•‡∏¢‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏õ‡∏µ';
                } else {
                    return `‡πÄ‡∏•‡∏¢ ${overdueDays} ‡∏ß‡∏±‡∏ô`;
                }
            } else if (timeRemaining === 0) {
                return '‡∏ß‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢';
            } else if (timeRemaining === 1) {
                return '‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏ß‡∏±‡∏ô';
            } else {
                return `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${timeRemaining} ‡∏ß‡∏±‡∏ô`;
            }
        }

        function formatReceivedDate(customer) {
            let dateToFormat = null;
            let source = '';
            
            if (customer.assign_date) {
                dateToFormat = customer.assign_date;
                source = '‡∏°‡∏≠‡∏ö‡∏´‡∏°‡∏≤‡∏¢';
            } else if (customer.created_date) {
                dateToFormat = customer.created_date;
                source = '‡∏™‡∏£‡πâ‡∏≤‡∏á';
            }
            
            if (!dateToFormat) {
                return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
            
            const formatted = formatDate(dateToFormat);
            return `${formatted} (${source})`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function updateSummary() {
            const summaryDiv = document.getElementById('summaryResult');
            const totalTests = Object.keys(testResults).length;
            const passedTests = Object.values(testResults).filter(result => result).length;
            
            let summary = `<div class="test-result ${passedTests === totalTests ? 'test-pass' : 'test-fail'}">`;
            summary += `<h6>üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏ß‡∏°: ${passedTests}/${totalTests}</h6>`;
            summary += `<ul>`;
            summary += `<li>API customers/list.php: ${testResults.customerAPI ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</li>`;
            summary += `<li>API dashboard/summary.php: ${testResults.dashboardAPI ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</li>`;
            summary += `<li>‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•: ${testResults.displayTest ? '‚úÖ ‡∏ú‡πà‡∏≤‡∏ô' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</li>`;
            summary += `</ul>`;
            
            if (passedTests === totalTests) {
                summary += '<div class="alert alert-success mt-3">üéâ ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î!</div>';
            } else {
                summary += '<div class="alert alert-warning mt-3">‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>';
            }
            
            summary += '</div>';
            summaryDiv.innerHTML = summary;
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                testCustomerListAPI();
                setTimeout(() => testDashboardAPI(), 1000);
                setTimeout(() => testDashboardDisplay(), 2000);
            }, 500);
        });
    </script>
</body>
</html>