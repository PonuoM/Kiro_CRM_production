# Story 1.2: Develop Lead Management Cron Job

## Status
✅ Ready for Review

## Story
**As a** System,
**I want** a daily automated script to run,
**so that** I can enforce the Hybrid Logic and Freezing rules.

## Acceptance Criteria
1. สร้างไฟล์ใหม่ที่ cron/auto_rules.php
2. Script ต้องดึงข้อมูลลูกค้าที่เข้าเงื่อนไข Hybrid Logic Rule (ทั้งตามเวลาและการปฏิสัมพันธ์) และอัปเดต CartStatus ได้อย่างถูกต้อง
3. Script ต้องดึงข้อมูลลูกค้าที่เข้าเงื่อนไข Freezing a Lead Rule และอัปเดต CustomerTemperature เป็น 'FROZEN' ได้อย่างถูกต้อง
4. Script จะต้องทำงานได้อย่างมีประสิทธิภาพและไม่ทำให้ฐานข้อมูลทำงานหนักเกินไป

## Tasks / Subtasks

- [x] Task 1: วิเคราะห์และออกแบบ Cron Job Logic (AC: 2,3)
  - [x] ศึกษา Hybrid Logic Rules จาก PRD (Time-Based และ Interaction-Based)
  - [x] ศึกษา Freezing a Lead Rules จาก PRD
  - [x] ออกแบบ SQL Queries สำหรับแต่ละกฎ
  - [x] กำหนด Performance Requirements และ Optimization Strategy

- [x] Task 2: พัฒนา Core Logic Functions (AC: 1,2,3)
  - [x] สร้างไฟล์ cron/auto_rules.php
  - [x] เขียนฟังก์ชัน processHybridLogicRule() สำหรับจัดการ Time-Based Rules
  - [x] เขียนฟังก์ชัน processInteractionBasedRule() สำหรับจัดการ Interaction-Based Rules  
  - [x] เขียนฟังก์ชัน processFreezingRule() สำหรับจัดการ Freezing Logic
  - [x] เพิ่ม Database Connection และ Error Handling

- [x] Task 3: ใช้งาน Security และ Performance Optimization (AC: 1,4)
  - [x] เพิ่ม Security Protection ป้องกันการเรียกใช้ผ่าน URL โดยตรง
  - [x] Optimize SQL Queries โดยใช้ Index และ LIMIT statements
  - [x] เพิ่ม Logging และ Monitoring capabilities
  - [x] เพิ่ม Execution Time Limits และ Memory Management

- [x] Task 4: ทดสอบและ Deployment (AC: 1,2,3,4)
  - [x] สร้าง Test Database พร้อม Mock Data
  - [x] ทดสอบ Hybrid Logic Rules ในสถานการณ์ต่างๆ
  - [x] ทดสอบ Freezing Rules และตรวจสอบ Edge Cases
  - [x] ทดสอบ Performance และ Memory Usage
  - [x] สร้าง Shell Script สำหรับ Cron Job Scheduling

## Dev Notes

### Previous Story Insights
**จาก Story 1.1** [Source: docs/stories/1.1.story.md]:
- ตาราง customers จะมีคอลัมน์ใหม่: ContactAttempts, AssignmentCount
- CustomerTemperature ENUM จะรองรับ 'FROZEN' แล้ว
- ต้องแน่ใจว่า Story 1.1 เสร็จสมบูรณ์ก่อนเริ่ม Story นี้

### Data Models
**Hybrid Logic Rules** [Source: docs/prd.md#lead-management-workflow]:

*Time-Based Rules*:
- ลูกค้าใหม่: ไม่มี call_logs ใหม่ภายใน 30 วัน → CartStatus = 'ตะกร้าแจก'
- ลูกค้าติดตาม/เก่า: ไม่มี orders ใหม่ภายใน 3 เดือน → CartStatus = 'ตะกร้ารอ'

*Interaction-Based Rules*:
- ลูกค้าใหม่: ContactAttempts >= 3 และยัง CustomerStatus = 'ลูกค้าใหม่' → CartStatus = 'ตะกร้าแจก'

**Freezing Rules** [Source: docs/prd.md#lead-management-workflow]:
- AssignmentCount >= 3 และถูกดึงคืนอีกครั้ง → CustomerTemperature = 'FROZEN'
- ไม่แสดงใน "ตะกร้าแจก" เป็นเวลา 6 เดือน

### API Specifications
- ไม่มีการเปลี่ยนแปลง API โดยตรง แต่ส่งผลกระทบต่อ CartStatus และ CustomerTemperature

### Component Specifications
- ไม่มีการเปลี่ยนแปลง UI Component ใน Story นี้

### File Locations
**Primary Files**:
- สร้างใหม่: `cron/auto_rules.php` - Main cron script
- สร้างใหม่: `cron/run_auto_rules.sh` - Shell script wrapper for cron scheduling

**Dependencies**:
- `includes/functions.php` - สำหรับ Database connection functions
- `config/database.php` - Database configuration

### Testing Requirements
**Testing Standards** [Source: docs/architecture.md#test-strategy]:
- Unit Testing สำหรับฟังก์ชันที่ซับซ้อนใน cron/auto_rules.php
- Integration Testing กับฐานข้อมูลจำลองเพื่อดูว่าข้อมูลถูกอัปเดตถูกต้อง

**Test Scenarios**:
- ทดสอบ Time-Based Rules ในสถานการณ์ต่างๆ
- ทดสอบ Interaction-Based Rules กับ Mock Data
- ทดสอบ Freezing Logic และ Edge Cases
- ทดสอบ Performance กับข้อมูลจำนวนมาก

### Technical Constraints
**Security Requirements** [Source: docs/architecture.md#backend-architecture]:
- ไฟล์ต้องถูกป้องกันไม่ให้เรียกใช้งานผ่าน URL โดยตรง
- ใช้ CLI mode หรือ HTTP authentication

**Performance Requirements** [Source: docs/architecture.md#implementation-notes]:
- Query ต้องมีประสิทธิภาพสูงและใช้ Index อย่างเหมาะสม
- ป้องกันปัญหาระบบช้าจาก Cron Job
- ควรมี Execution Time Limits

**Cron Job Scheduling** [Source: docs/architecture.md#implementation-notes]:
- การตั้งเวลา Cron Job บน Server เป็นขั้นตอน Infrastructure ที่ต้องทำหลังพัฒนา Script

### Testing
**Test file location**: `tests/cron/`
**Test standards**:
- Unit Tests สำหรับแต่ละ Logic Function
- Integration Tests กับฐานข้อมูลจำลอง
- Performance Tests กับ Large Dataset
**Testing frameworks and patterns to use**:
- PHP Unit Testing framework
- Database Fixtures สำหรับ Mock Data
- Memory และ Execution Time Profiling
**Specific testing requirements for this story**:
- ทดสอบทุก Hybrid Logic Scenarios
- ทดสอบ Freezing Rules ในสถานการณ์ Edge Cases
- ทดสอบ Performance ไม่ให้เกิน Memory และ Time Limits

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 26/07/2568 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
Claude Code SuperClaude Framework (Sonnet 4) - BMad-Method v2.0

### Debug Log References  
- story_1.2_completion_report.md - Complete implementation documentation
- validate_auto_rules_deployment.php - Deployment validation script
- tests/cron/test_auto_rules.php - Comprehensive test suite

### Completion Notes List
✅ All Acceptance Criteria implemented and validated
✅ Hybrid Logic Rules (Time-Based and Interaction-Based) implemented
✅ Freezing Rules with CustomerTemperature = 'FROZEN' implemented  
✅ Performance optimization with LIMIT clauses and proper indexing
✅ Security protection (CLI-only access) implemented
✅ Comprehensive logging and monitoring system
✅ Error handling and transaction safety
✅ Test suite created with full coverage
✅ Deployment validation script created
✅ Production-ready with proper documentation

### File List
**Core Implementation Files:**
- cron/auto_rules.php (496 lines) - Main automation logic with LeadManagementAutomation class
- cron/run_auto_rules.sh (36 lines) - Shell wrapper for cron execution

**Testing & Validation Files:**
- tests/cron/test_auto_rules.php (516 lines) - Comprehensive test suite
- validate_auto_rules_deployment.php (144 lines) - Deployment validation script
- story_1.2_completion_report.md (315 lines) - Complete implementation documentation

## QA Results
*Results from QA Agent QA review of the completed story implementation*