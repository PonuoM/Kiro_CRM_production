# Story 2.1: Implement Lead Re-assignment Logic

## Status
✅ Ready for Review

## Story
**As a** System,
**I want** to automatically re-assign leads when a sales user is deactivated,
**so that** no lead is left unattended.

## Acceptance Criteria
1. แก้ไข Logic ในหน้า pages/admin/user_management.php (หรือ API ที่เกี่ยวข้อง api/users/toggle_status.php)
2. เมื่อสถานะ users.Status ของ Sales ถูกเปลี่ยนเป็น Inactive (หรือ 0), ระบบจะต้อง Trigger Logic การโอนย้ายรายชื่อ
3. รายชื่อที่มี tasks.Status = 'รอดำเนินการ' จะต้องถูกเปลี่ยน customers.Sales ให้เป็น supervisor_id ของ Sales คนนั้น
4. รายชื่อที่เป็น 'ลูกค้าติดตาม' จะต้องถูกเปลี่ยน customers.CartStatus เป็น 'ตะกร้ารอ'
5. รายชื่อที่เป็น 'ลูกค้าใหม่' และยังไม่เคยติดต่อ จะต้องถูกเปลี่ยน customers.CartStatus เป็น 'ตะกร้าแจก'

## Tasks / Subtasks

- [x] Task 1: วิเคราะห์ Sales Departure Workflow (AC: 1,2)
  - [x] ตรวจสอบ User Management system ปัจจุบัน
  - [x] ศึกษา Toggle Status Logic ใน api/users/toggle_status.php
  - [x] วิเคราะห์ความสัมพันธ์ระหว่าง users, customers, และ tasks tables
  - [x] ออกแบบ 3-tier reassignment logic ตาม PRD

- [x] Task 2: พัฒนา Sales Departure Detection (AC: 1,2)
  - [x] เพิ่ม Logic ตรวจสอบ Role = 'Sales' ใน toggle_status.php
  - [x] เพิ่มฟังก์ชัน triggerSalesDepartureWorkflow()
  - [x] สร้าง Logging และ Audit Trail สำหรับ Departure events
  - [x] เพิ่ม Error handling และ Transaction management

- [x] Task 3: พัฒนา Lead Reassignment Categories (AC: 3,4,5)
  - [x] เขียนฟังก์ชัน reassignActiveTaskLeads() สำหรับ AC 3
  - [x] เขียนฟังก์ชัน moveFollowUpLeadsToWaiting() สำหรับ AC 4  
  - [x] เขียนฟังก์ชัน moveNewLeadsToDistribution() สำหรับ AC 5
  - [x] เพิ่ม Supervisor lookup และ validation logic

- [x] Task 4: Integration และ Testing (AC: 1,2,3,4,5)
  - [x] สร้าง comprehensive test scenarios สำหรับทั้ง 3 categories
  - [x] ทดสอบ Edge cases (ไม่มี Supervisor, Multiple assignments)
  - [x] ทดสอบ Transaction rollback เมื่อเกิด error
  - [x] ทดสอบ Performance และ Data integrity

## Dev Notes

### Previous Story Insights
**จาก Story 1.1** [Source: docs/stories/1.1.story.md]:
- ตาราง users มีคอลัมน์ supervisor_id แล้วสำหรับ lookup Supervisor
- ตาราง customers มี ContactAttempts และ AssignmentCount tracking

**จาก Story 1.2, 1.3** [Source: docs/stories/1.2.story.md, docs/stories/1.3.story.md]:
- Cron Job และ Assignment tracking systems พร้อมใช้งาน
- Business rules สำหรับ CartStatus management มีอยู่แล้ว

### Data Models
**Sales Departure Workflow Categories** [Source: docs/prd.md#sales-departure-workflow]:

*Category 1 - Active Tasks*:
- เงื่อนไข: customers ที่มี tasks.Status = 'รอดำเนินการ'
- การดำเนินการ: เปลี่ยน customers.Sales → users.supervisor_id

*Category 2 - Follow-up Customers*:
- เงื่อนไข: customers.CustomerStatus = 'ลูกค้าติดตาม' แต่ไม่มี active tasks
- การดำเนินการ: เปลี่ยน customers.CartStatus = 'ตะกร้ารอ'

*Category 3 - New Uncontacted Customers*:
- เงื่อนไข: customers.CustomerStatus = 'ลูกค้าใหม่' และ ContactAttempts = 0
- การดำเนินการ: เปลี่ยน customers.CartStatus = 'ตะกร้าแจก'

### API Specifications
**api/users/toggle_status.php modifications** [Source: docs/architecture.md#backend-architecture]:
- เพิ่ม Logic ตรวจสอบว่า Role ของผู้ใช้คือ 'Sales' หรือไม่
- หากใช่ ให้ Trigger Sales Departure Workflow
- เพิ่ม Response fields เพื่อรายงานผลการโอนย้าย leads

**New Workflow Functions**:
- `triggerSalesDepartureWorkflow($user_id)` - Main orchestrator
- `reassignActiveTaskLeads($sales_id, $supervisor_id)` - Handle Category 1
- `moveFollowUpLeadsToWaiting($sales_id)` - Handle Category 2
- `moveNewLeadsToDistribution($sales_id)` - Handle Category 3

### Component Specifications
**Admin Interface Updates**:
- pages/admin/user_management.php อาจต้องแสดงผลการโอนย้าย leads
- เพิ่ม confirmation dialog สำหรับ Sales deactivation
- แสดงสรุปจำนวน leads ที่ถูกโอนย้ายในแต่ละ category

### File Locations
**Primary Files**:
- แก้ไข: `api/users/toggle_status.php` - Main departure trigger
- แก้ไข: `pages/admin/user_management.php` - UI integration
- สร้างใหม่: `includes/SalesDepartureWorkflow.php` - Workflow logic class

**Dependencies**:
- `includes/functions.php` - Database functions
- `includes/User.php` - User model class
- `includes/Customer.php` - Customer model class
- `includes/Task.php` - Task model class

### Testing Requirements
**Testing Standards** [Source: docs/architecture.md#test-strategy]:
- End-to-End Testing สำหรับ complete Sales Departure Workflow
- Unit Testing สำหรับแต่ละ reassignment function
- Integration Testing กับ multiple database tables

**Test Scenarios**:
- Sales มี Active Tasks → Tasks ถูกโอนไปที่ Supervisor
- Sales มี Follow-up Customers → ย้ายไป Waiting Basket
- Sales มี New Uncontacted Leads → ย้ายไป Distribution Basket
- Sales ไม่มี Supervisor → Error handling
- Mixed scenarios → ทุก category ทำงานพร้อมกัน

### Technical Constraints
**Data Integrity Requirements**:
- ใช้ Database Transaction เพื่อรับประกันความสมบูรณ์
- ทุก reassignment ต้องสำเร็จหรือล้มเหลวพร้อมกัน
- Audit trail สำหรับ compliance และ debugging

**Performance Requirements**:
- Departure workflow ต้องทำงานเร็วเพื่อไม่กระทบ Admin UX
- Bulk updates ต้องมีประสิทธิภาพสำหรับ Sales ที่มี leads จำนวนมาก

**Business Logic Requirements** [Source: docs/prd.md#sales-departure-workflow]:
- การจำแนก leads ต้องตรงตาม business rules ทั้ง 3 categories
- Supervisor assignment ต้องอ้างอิงจาก organizational hierarchy
- Error scenarios ต้องไม่ทำให้ leads หายหรือซ้ำซ้อน

### Testing
**Test file location**: `tests/workflows/`
**Test standards**:
- End-to-End Workflow Testing
- Unit Tests สำหรับแต่ละ reassignment function
- Database Transaction Testing
**Testing frameworks and patterns to use**:
- PHP Unit Testing framework
- Database transaction testing
- Mock data สำหรับ multiple Sales scenarios
**Specific testing requirements for this story**:
- ทดสอบทั้ง 3 categories ของ lead reassignment
- ทดสอบ Error scenarios และ rollback mechanisms
- ทดสอบ Performance กับ large number of leads
- ทดสอบ Supervisor lookup และ edge cases

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 26/07/2568 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section is populated by the development agent during implementation*

### Agent Model Used
Claude Code SuperClaude Framework (Sonnet 4) - BMad-Method v2.0

### Debug Log References  
- SalesDepartureWorkflow.php - Main workflow implementation class
- test_sales_departure.php - Comprehensive test suite for all 3 categories
- validate_story_2_1.php - Production readiness validation script
- toggle_status.php - Enhanced API with departure workflow integration

### Completion Notes List
✅ All Acceptance Criteria implemented and validated
✅ 3-tier lead reassignment logic: Active Tasks → Supervisor, Follow-up → Waiting, New → Distribution
✅ Sales departure detection integrated in user toggle status API
✅ Transaction safety with rollback protection for data integrity
✅ Comprehensive test suite covering all categories and edge cases
✅ Enhanced API responses with departure workflow results
✅ Error handling and audit logging implemented
✅ Supervisor lookup with graceful handling of missing supervisors
✅ Production validation script created and ready
✅ Performance optimized with bulk operations and efficient queries

### File List
**Core Implementation Files:**
- api/users/toggle_status.php (92 → 118 lines) - Enhanced API with sales departure detection
- includes/SalesDepartureWorkflow.php (461 lines) - Complete 3-tier lead reassignment workflow

**Testing & Validation Files:**
- tests/workflows/test_sales_departure.php (595 lines) - Comprehensive test suite for all categories
- validate_story_2_1.php (280 lines) - Production readiness validation script

## QA Results
*Results from QA Agent QA review of the completed story implementation*