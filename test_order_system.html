<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Order System</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        .result { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .autocomplete-container { position: relative; }
        .product-search { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .product-suggestions { 
            position: absolute; background: white; border: 1px solid #ddd; 
            max-height: 200px; overflow-y: auto; z-index: 1000; width: 100%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: none;
        }
        .product-suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .product-suggestion-item:hover { background-color: #f8f9fa; }
        .suggestion-code { font-weight: bold; color: #007bff; }
        .suggestion-name { color: #6c757d; font-size: 0.9em; }
        .suggestion-price { color: #28a745; font-size: 0.85em; float: right; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Order System Components</h1>
        
        <!-- Test Products API -->
        <div class="test-section">
            <h3>1. Test Products API</h3>
            <button onclick="testProductsAPI()">Load Products</button>
            <div id="products-result" class="result"></div>
        </div>
        
        <!-- Test Autocomplete -->
        <div class="test-section">
            <h3>2. Test Product Autocomplete</h3>
            <div class="autocomplete-container">
                <input type="text" id="test-search" class="product-search" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." autocomplete="off">
                <div id="test-suggestions" class="product-suggestions"></div>
            </div>
            <div id="selected-product" class="result">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </div>
        
        <!-- Test Order Creation -->
        <div class="test-section">
            <h3>3. Test Order Creation API</h3>
            <button onclick="testOrderCreation()">Create Test Order</button>
            <div id="order-result" class="result"></div>
        </div>
    </div>

    <script>
        let productsData = [];
        
        // Test Products API
        async function testProductsAPI() {
            const resultDiv = document.getElementById('products-result');
            resultDiv.innerHTML = 'Loading products...';
            
            try {
                const response = await fetch('api/products/list.php');
                const data = await response.json();
                
                if (data.success) {
                    productsData = data.data;
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Products loaded successfully!<br>
                            Total: ${data.total_count} products<br>
                            Categories: ${data.categories.join(', ')}<br>
                            ${data.note ? `Note: ${data.note}` : ''}
                        </div>
                    `;
                    
                    // Initialize autocomplete after loading products
                    initializeAutocomplete();
                } else {
                    resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Initialize autocomplete functionality
        function initializeAutocomplete() {
            const searchInput = document.getElementById('test-search');
            const suggestions = document.getElementById('test-suggestions');
            
            searchInput.addEventListener('input', function() {
                searchProducts(this);
            });
            
            searchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0) {
                    searchProducts(this);
                } else {
                    showSuggestions(this, productsData);
                }
            });
            
            searchInput.addEventListener('blur', function() {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                }, 200);
            });
        }
        
        // Search products
        function searchProducts(inputElement) {
            const query = inputElement.value.toLowerCase().trim();
            const suggestions = document.getElementById('test-suggestions');
            
            if (query.length < 1) {
                suggestions.style.display = 'none';
                return;
            }
            
            const filteredProducts = productsData.filter(product => 
                product.product_code.toLowerCase().includes(query) ||
                product.product_name.toLowerCase().includes(query)
            );
            
            showSuggestions(inputElement, filteredProducts);
        }
        
        // Show suggestions
        function showSuggestions(inputElement, products) {
            const suggestions = document.getElementById('test-suggestions');
            
            if (products.length === 0) {
                suggestions.innerHTML = '<div class="product-suggestion-item">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                suggestions.style.display = 'block';
                return;
            }
            
            suggestions.innerHTML = '';
            
            // Group by category
            const categories = {};
            products.forEach(product => {
                if (!categories[product.category]) {
                    categories[product.category] = [];
                }
                categories[product.category].push(product);
            });
            
            // Display grouped suggestions
            Object.keys(categories).sort().forEach(category => {
                categories[category].forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'product-suggestion-item';
                    item.innerHTML = `
                        <div class="suggestion-code">${product.product_code}</div>
                        <div class="suggestion-name">${product.product_name}</div>
                        <div class="suggestion-price">${parseFloat(product.standard_price || 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó</div>
                    `;
                    
                    item.addEventListener('click', () => selectProduct(inputElement, product));
                    suggestions.appendChild(item);
                });
            });
            
            suggestions.style.display = 'block';
        }
        
        // Select product
        function selectProduct(inputElement, product) {
            inputElement.value = `${product.product_code} - ${product.product_name}`;
            document.getElementById('test-suggestions').style.display = 'none';
            
            document.getElementById('selected-product').innerHTML = `
                <div class="success">
                    ‚úÖ Selected Product:<br>
                    Code: ${product.product_code}<br>
                    Name: ${product.product_name}<br>
                    Category: ${product.category}<br>
                    Price: ${parseFloat(product.standard_price || 0).toFixed(2)} ‡∏ö‡∏≤‡∏ó/${product.unit}
                </div>
            `;
        }
        
        // Test Order Creation
        async function testOrderCreation() {
            const resultDiv = document.getElementById('order-result');
            resultDiv.innerHTML = 'Creating test order...';
            
            const testOrder = {
                CustomerCode: 'TEST001',
                DocumentDate: new Date().toISOString().split('T')[0],
                PaymentMethod: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',
                products: [
                    {
                        code: 'F001',
                        name: '‡∏õ‡∏∏‡πã‡∏¢‡πÄ‡∏Ñ‡∏°‡∏µ 16-16-16',
                        quantity: 2,
                        price: 18.50
                    },
                    {
                        code: 'O001',
                        name: '‡∏õ‡∏∏‡πã‡∏¢‡∏´‡∏°‡∏±‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏Å‡∏°‡∏î',
                        quantity: 1,
                        price: 45.00
                    }
                ]
            };
            
            try {
                const response = await fetch('api/orders/create.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testOrder)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Order created successfully!<br>
                            Document No: ${data.data.DocumentNo}<br>
                            Message: ${data.message}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">
                            ‚ùå Order creation failed:<br>
                            ${data.message}<br>
                            ${data.errors ? data.errors.join('<br>') : ''}
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }
        
        // Auto-load products when page loads
        document.addEventListener('DOMContentLoaded', function() {
            testProductsAPI();
        });
    </script>
</body>
</html>